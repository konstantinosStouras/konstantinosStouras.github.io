<section class="card" style="max-width:100%;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h2 style="margin:0;border:none;padding:0;">Phase: Individual Ideation (10 min)</h2>
    <div id="timer" style="font-size:1.1rem;font-weight:600;background:#eef2ff;color:#1e40af;padding:8px 14px;border-radius:8px;">10:00</div>
  </div>

  <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:20px;margin-bottom:20px;">
    <p style="margin:0 0 12px;">
      Welcome to the <strong>Individual Phase</strong> of the challenge.
    </p>
    
    <p style="margin:0 0 12px;">
      In this part, you'll work <strong>completely on your own</strong> to generate ideas for new products in the 
      <strong>health and wellness market</strong>. Please <strong>do not communicate or collaborate</strong> with others during this phase.
    </p>
    
    <p style="margin:0 0 12px;">
      Focus on creating as many ideas as you can – big or small, practical or experimental. Each idea should aim to 
      offer value, improvement, or innovation in health and wellness.
    </p>
    
    <p style="margin:0 0 16px;">
      You'll have a limited amount of time to complete this phase, so work efficiently and record your ideas clearly. 
      When the timer ends, you'll move on to the next stage.
    </p>

    <h3 style="margin:0 0 12px;font-size:16px;border:none;padding:0;">Your Task</h3>
    <ul style="margin:0 0 16px;padding-left:20px;">
      <li>Think independently</li>
      <li>Develop original product ideas</li>
      <li>Describe each idea briefly and clearly</li>
    </ul>
  </div>

  <p id="instructionText" style="font-weight:600;color:#1e40af;">
    Brainstorm ideas below and select your Top 5 to finalize.
  </p>
</section>

<section class="card ideas-box" style="max-width:100%;">
  <h2>Your Ideas</h2>
  
  <div style="margin-bottom:16px;">
    <label for="ideaTitle" style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Idea title</label>
    <input type="text" id="ideaTitle" placeholder="Enter your idea title" />
  </div>
  
  <div style="margin-bottom:16px;">
    <label for="ideaDesc" style="display:block;font-weight:600;margin-bottom:6px;font-size:14px;">Idea description</label>
    <textarea id="ideaDesc" placeholder="Describe your idea in detail"></textarea>
  </div>
  
  <button id="addIdea" class="btn">Add Idea</button>

  <ul id="ideasList" style="list-style:none;padding:0;margin:20px 0 0;"></ul>

  <h2 style="margin-top:24px;border:none;padding:0;">Personal Notes</h2>
  <textarea id="notes" rows="5" placeholder="Write notes here (private)"></textarea>
</section>

<section class="card" style="max-width:100%;margin-top:24px;">
  <h2 style="margin:0;border:none;padding:0 0 10px 0;border-bottom:1px solid var(--border);">Select Top 5</h2>
  <ul id="top5List" style="list-style:none;padding:0;margin-top:16px;"></ul>

  <h2 style="margin-top:20px;">Selected Top 5 – edit before finalizing</h2>
  <p class="hint">You can revise each selected idea's <strong>title</strong> and <strong>description</strong> below.</p>
  <ul id="finalEditList" style="list-style:none;padding:0;"></ul>
  
  <div style="margin-top:20px;text-align:center;">
    <button id="submitAll" class="btn" data-next>Submit</button>
  </div>
</section>

<script>
(function() {
  // Wrap everything in an IIFE to avoid global scope pollution
  console.log("Phase 1 script starting...");
  
  const MANDATORY_MODE = false; // Testing mode - validation disabled
  
  // Timer setup
  let time = 600;
  const timerEl = document.getElementById("timer");
  
  function updateTimer(){
    const m = String(Math.floor(time/60)).padStart(2,"0");
    const s = String(time%60).padStart(2,"0");
    timerEl.textContent = `${m}:${s}`;
    if(time>0) time--; 
    else clearInterval(timerInterval);
  }
  
  const timerInterval = setInterval(updateTimer, 1000);
  updateTimer();

  // Data arrays
  const ideas = [];
  const top5 = []; // Changed from Set to Array to maintain order

  // Escape HTML helper
  function escapeHtml(str){
    if (!str) return '';
    return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  // Get DOM elements
  const addIdeaBtn = document.getElementById("addIdea");
  const ideaTitleInput = document.getElementById("ideaTitle");
  const ideaDescInput = document.getElementById("ideaDesc");
  const ideasListEl = document.getElementById("ideasList");
  const submitBtn = document.getElementById("submitAll");

  // Verify elements exist
  if (!addIdeaBtn) {
    console.error("ERROR: Add Idea button not found!");
    return;
  }
  if (!ideaTitleInput || !ideaDescInput) {
    console.error("ERROR: Input fields not found!");
    return;
  }

  console.log("All elements found successfully");

  // Add idea handler
  function handleAddIdea() {
    console.log("Add Idea button clicked!");
    
    const title = ideaTitleInput.value.trim();
    const desc = ideaDescInput.value.trim();
    
    console.log("Title:", title, "Desc:", desc);
    
    if (!title || !desc) {
      alert("Please enter both title and description.");
      return;
    }
    
    const id = ideas.length + 1;
    ideas.push({ id, title, desc });
    
    console.log("Idea added. Total ideas:", ideas.length);
    
    renderIdeas();
    
    // Clear inputs
    ideaTitleInput.value = "";
    ideaDescInput.value = "";
  }

  // Attach event listener
  addIdeaBtn.addEventListener('click', handleAddIdea);
  console.log("Event listener attached to Add Idea button");

  // Render ideas list
  function renderIdeas(){
    console.log("Rendering ideas...", ideas.length);
    
    ideasListEl.innerHTML = "";
    
    ideas.forEach((idea, index) => {
      const li = document.createElement("li");
      li.style.cssText = "margin:12px 0;padding:14px;border:1px solid #ddd;border-radius:8px;background:#f9fafb;";
      li.innerHTML = `
        <div style="margin-bottom:6px;"><strong>Title:</strong> ${escapeHtml(idea.title)}</div>
        <div style="margin-bottom:10px;"><strong>Description:</strong> ${escapeHtml(idea.desc)}</div>
        <div><label style="cursor:pointer;display:inline-flex;align-items:center;gap:6px;"><input type="checkbox" data-idea-id="${idea.id}" class="top5-checkbox"> <span>Mark as Top-5</span></label></div>`;
      ideasListEl.appendChild(li);
    });
    
    // Attach checkbox listeners
    document.querySelectorAll('.top5-checkbox').forEach(checkbox => {
      const ideaId = parseInt(checkbox.getAttribute('data-idea-id'));
      checkbox.checked = top5.includes(ideaId);
      checkbox.addEventListener('change', () => toggleTop5(ideaId));
    });
    
    renderTop5();
  }

  // Toggle top 5 selection
  function toggleTop5(id){
    console.log("Toggle top 5 for idea:", id);
    
    const index = top5.indexOf(id);
    if(index > -1) {
      top5.splice(index, 1);
    } else {
      if(top5.length >= 5) {
        alert("You can only pick 5 ideas.");
        // Uncheck the checkbox
        const checkbox = document.querySelector(`.top5-checkbox[data-idea-id="${id}"]`);
        if (checkbox) checkbox.checked = false;
        return;
      }
      top5.push(id);
    }
    renderTop5();
  }

  // Render top 5 section with drag-and-drop
  let draggedElement = null;
  let draggedId = null;

  function renderTop5(){
    const editUl = document.getElementById("finalEditList");
    
    editUl.innerHTML = "";

    top5.forEach((id, index) => {
      const idea = ideas.find(i => i.id === id);
      if (!idea) return;

      // Edit list with drag-and-drop
      const li = document.createElement("li");
      li.style.cssText = "margin:8px 0;cursor:move;";
      li.draggable = true;
      li.dataset.ideaId = id;
      
      li.innerHTML = `
        <div class="final-box" style="background:#eef2ff;border:1px solid #c7d2fe;border-radius:8px;padding:12px;position:relative;">
          <div style="position:absolute;top:12px;right:12px;color:#6b7280;font-size:20px;cursor:move;" title="Drag to reorder">⋮⋮</div>
          <label style="font-weight:600;display:block;margin:4px 0;">Idea title</label>
          <input type="text" data-final-title="${id}" value="${escapeHtml(idea.title)}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
          <label style="font-weight:600;display:block;margin:8px 0 4px;">Idea description</label>
          <textarea data-final-desc="${id}" rows="3" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;resize:vertical;">${escapeHtml(idea.desc)}</textarea>
        </div>`;
      
      // Drag event handlers
      li.addEventListener('dragstart', (e) => {
        draggedElement = li;
        draggedId = id;
        li.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
      });
      
      li.addEventListener('dragend', (e) => {
        li.style.opacity = '1';
        draggedElement = null;
        draggedId = null;
      });
      
      li.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        
        if (draggedElement && draggedElement !== li) {
          const rect = li.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          
          if (e.clientY < midpoint) {
            li.style.borderTop = '3px solid #2563eb';
            li.style.borderBottom = '';
          } else {
            li.style.borderBottom = '3px solid #2563eb';
            li.style.borderTop = '';
          }
        }
      });
      
      li.addEventListener('dragleave', (e) => {
        li.style.borderTop = '';
        li.style.borderBottom = '';
      });
      
      li.addEventListener('drop', (e) => {
        e.preventDefault();
        li.style.borderTop = '';
        li.style.borderBottom = '';
        
        if (draggedElement && draggedElement !== li) {
          const draggedIndex = top5.indexOf(draggedId);
          const targetId = parseInt(li.dataset.ideaId);
          const targetIndex = top5.indexOf(targetId);
          
          // Remove dragged item
          top5.splice(draggedIndex, 1);
          
          // Insert at new position
          const rect = li.getBoundingClientRect();
          const midpoint = rect.top + rect.height / 2;
          const insertIndex = e.clientY < midpoint ? targetIndex : targetIndex + 1;
          
          top5.splice(insertIndex, 0, draggedId);
          
          renderTop5();
        }
      });
      
      editUl.appendChild(li);
    });
  }

  // Submit handler
  submitBtn.addEventListener('click', () => {
    console.log("Submit clicked");
    
    if(MANDATORY_MODE && top5.length !== 5){
      alert("Please select exactly 5 ideas before submitting.");
      return;
    }

    // Collect finalized ideas in order
    const finalIdeas = top5.map(id => {
      const titleEl = document.querySelector(`[data-final-title="${id}"]`);
      const descEl = document.querySelector(`[data-final-desc="${id}"]`);
      return {
        id,
        finalTitle: titleEl ? titleEl.value.trim() : '',
        finalDescription: descEl ? descEl.value.trim() : ''
      };
    });

    // Validate that all top 5 have finalized content
    if(MANDATORY_MODE){
      const incomplete = finalIdeas.some(idea => !idea.finalTitle || !idea.finalDescription);
      if(incomplete){
        alert("Please ensure all Top 5 ideas have both title and description filled in the edit section.");
        return;
      }
    }

    const payload = {
      top5: finalIdeas
    };

    console.log("Phase 1 submission:", payload);
    
    if(window.__APP__) window.__APP__.next();
  });

  console.log("Phase 1 script initialization complete");
})();
</script>