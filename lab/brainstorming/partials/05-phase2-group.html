<section class="card" style="max-width:100%;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h2 style="margin:0;border:none;padding:0;">Phase: Group Ideation (20 min)</h2>
    <div id="timer" style="font-size:1.1rem;font-weight:600;background:#eef2ff;color:#1e40af;padding:8px 14px;border-radius:8px;">20:00</div>
  </div>

  <div style="background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:10px;margin-bottom:12px;">
    <strong>Leader:</strong> <span id="leaderName">â€”</span>
  </div>
</section>

<section class="card" style="max-width:100%;">
  <h2>Add Group Ideas</h2>
  <input id="groupIdeaTitle" type="text" placeholder="Idea title" />
  <textarea id="groupIdeaDesc" placeholder="Idea description"></textarea>
  <input id="groupIdeaSource" type="text" placeholder="Source (e.g., Member name or 'New')" />
  <button id="addGroupIdea" class="btn">Add Idea</button>
</section>

<section class="card" style="max-width:100%;">
  <h2>All Group Ideas</h2>
  <ul id="groupIdeasList" style="list-style:none;padding:0;"></ul>
</section>

<div style="margin-top:16px;text-align:right;">
  <button id="submitGroupTop5" class="btn" disabled>Submit Final Top-5 â†’</button>
</div>

<script>
  const MANDATORY_MODE = false; // Testing mode - validation disabled
  
  let time = 1200;
  const timerEl = document.getElementById("timer");
  function updateTimer(){
    const m = String(Math.floor(time/60)).padStart(2,'0');
    const s = String(time%60).padStart(2,'0');
    timerEl.textContent=`${m}:${s}`;
    if(time>0) time--;
    else{ clearInterval(timerInterval); alert("Time's up! Please finalize your ideas."); }
  }
  const timerInterval = setInterval(updateTimer,1000);
  updateTimer();

  const leaderNameEl = document.getElementById('leaderName');
  leaderNameEl.textContent = "Alice";

  const groupIdeas = [];
  const groupTop5 = new Set();

  const addBtn = document.getElementById("addGroupIdea");
  const submitBtn = document.getElementById("submitGroupTop5");

  addBtn.onclick = ()=>{
    const title=document.getElementById("groupIdeaTitle").value.trim();
    const desc=document.getElementById("groupIdeaDesc").value.trim();
    const src=document.getElementById("groupIdeaSource").value.trim()||"New";
    if(!title||!desc){ alert("Please enter both title and description."); return; }
    const id=groupIdeas.length+1;
    groupIdeas.push({id,title,desc,src});
    renderIdeas();
    document.getElementById("groupIdeaTitle").value="";
    document.getElementById("groupIdeaDesc").value="";
    document.getElementById("groupIdeaSource").value="";
  };

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function renderIdeas(){
    const ul=document.getElementById("groupIdeasList");
    ul.innerHTML="";
    groupIdeas.forEach(i=>{
      const li=document.createElement("li");
      li.style.cssText="margin:8px 0;padding:10px;border:1px solid #ddd;border-radius:6px;background:#f9fafb;";
      li.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div><strong>${escapeHtml(i.title)}</strong> <span style="background:#dbeafe;color:#1e40af;font-size:0.75rem;padding:2px 8px;border-radius:6px;margin-left:4px;">${escapeHtml(i.src)}</span><br>${escapeHtml(i.desc)}</div>
          <label style="cursor:pointer;"><input type="checkbox" onchange="toggleTop5(${i.id})" ${groupTop5.has(i.id)?"checked":""}> Final Top-5</label>
        </div>`;
      ul.appendChild(li);
    });
    renderTop5();
  }

  window.toggleTop5 = (id)=>{
    if(groupTop5.has(id)) groupTop5.delete(id);
    else{
      if(groupTop5.size>=5){ alert("You can only select 5 ideas."); return; }
      groupTop5.add(id);
    }
    renderTop5();
    submitBtn.disabled = groupTop5.size!==5;
  };

  function renderTop5(){
    const ul=document.getElementById("groupTop5List");
    ul.innerHTML="";
    [...groupTop5].forEach(id=>{
      const idea=groupIdeas.find(i=>i.id===id);
      if(idea){
        const li=document.createElement("li");
        li.style.cssText="margin:8px 0;padding:12px;border:1px solid #c7d2fe;border-radius:8px;background:#eef2ff;";
        li.innerHTML=`
          <strong>${escapeHtml(idea.title)}</strong> <span style="background:#dbeafe;color:#1e40af;font-size:0.75rem;padding:2px 8px;border-radius:6px;">${escapeHtml(idea.src)}</span><br>${escapeHtml(idea.desc)}
          <div style="margin-top:10px;">
            <label style="font-weight:600;display:block;margin:4px 0;"><strong>Final Idea Title:</strong></label>
            <input type="text" data-final-title="${id}" value="${escapeHtml(idea.title)}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
            <label style="font-weight:600;display:block;margin:8px 0 4px;"><strong>Short Final Description:</strong></label>
            <textarea data-final-desc="${id}" placeholder="Write the short final description..." style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;resize:vertical;" rows="3"></textarea>
          </div>`;
        ul.appendChild(li);
      }
    });
  }

  submitBtn.onclick = async () => {
    if (MANDATORY_MODE && groupTop5.size !== 5) {
      alert("Please select exactly 5 ideas.");
      return;
    }

    // Collect the top 5 final ideas with their finalized titles/descriptions
    const top5Array = [...groupTop5];
    const results = top5Array.map(id => {
      const idea = groupIdeas.find(i => i.id === id);
      const titleInput = document.querySelector(`input[data-final-title="${id}"]`);
      const descInput = document.querySelector(`textarea[data-final-desc="${id}"]`);
      return {
        id: id,
        originalTitle: idea ? idea.title : '',
        originalDesc: idea ? idea.desc : '',
        originalSource: idea ? idea.src : '',
        finalTitle: titleInput ? titleInput.value.trim() : '',
        finalDesc: descInput ? descInput.value.trim() : ''
      };
    });

    // Validate all have content in mandatory mode
    if(MANDATORY_MODE){
      const incomplete = results.some(r => !r.finalTitle || !r.finalDesc);
      if(incomplete){
        alert("Please complete all title and description fields for the Top 5 ideas.");
        return;
      }
    }

    console.log("Submitted - All Group Ideas:", groupIdeas);
    console.log("Submitted - Final Top-5 (ordered):", results);

    // ðŸ”¥ LOG TO GOOGLE SHEETS - ALL GROUP IDEAS + TOP 5 IN ORDER
    if (window.__APP__ && window.__APP__.logData) {
      await window.__APP__.logData({
        type: 'phase2_group',
        participantId: window.__APP__.participantId,
        allGroupIdeas: groupIdeas,    // ALL group ideas generated
        finalTop5: results,            // Top 5 in order with final edits
        groupLeader: leaderNameEl.textContent
      });
    }

    if (window.__APP__) window.__APP__.next();
  };
</script>